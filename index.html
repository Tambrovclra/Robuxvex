<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=1024">
  <title>ROBUXVEX - Dashboard</title>
  <style>
    body { margin:0; font-family:'Poppins',sans-serif; background:#f4f6fa; color:#333; }
    .navbar { position:fixed; top:0; left:0; right:0; height:60px; background:#fff; display:flex; align-items:center; justify-content:space-between; padding:0 20px; box-shadow:0 2px 10px rgba(0,0,0,0.1); z-index:1000; }
    .icon-btn { width:38px;height:38px;border-radius:50%;background:#eee; display:flex;align-items:center;justify-content:center;cursor:pointer; }
    .icon-btn svg { width:20px;height:20px;fill:#333; }
    #dropdownBox { position:fixed;top:65px;right:20px;background:#fff;border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.25);display:none;min-width:280px;padding:20px; }
    #dropdownBox img { width:80px;height:80px;border-radius:50%;display:block;margin:0 auto 10px;border:4px solid #3498db;box-shadow:0 0 15px rgba(52,152,219,0.6);transition:all 0.3s ease; }
    #dropdownBox img:hover { box-shadow:0 0 25px rgba(52,152,219,0.9),0 0 40px rgba(52,152,219,0.7);transform:scale(1.05); }
    #dropdownBox h3 { text-align:center;margin:5px 0 15px; }
    .info-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; text-align:center; margin-bottom:15px; }
    .info-box { background:#f9f9f9;padding:10px;border-radius:12px;box-shadow:inset 0 0 8px rgba(0,0,0,0.05);transition:0.3s; }
    .info-box:hover { background:#eef7ff; box-shadow:0 0 12px rgba(52,152,219,0.4); }
    .info-box p { margin:4px 0; font-size:13px; }
    .info-box strong { font-size:14px; display:block; }
    #dropdownBox a { display:block;padding:10px 14px;color:#333;text-decoration:none;border-radius:8px;margin-top:5px;text-align:center; }
    #dropdownBox a:hover { background:#f4f6fa; }
    #dropdownBox .logout { color:#e74c3c;font-weight:600; }
    .container { padding:80px 20px 40px; max-width:1200px; margin:auto; }
    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:20px; }
    .card { background:#fff;border-radius:16px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.08); text-align:center;transition:transform 0.2s; }
    .card:hover { transform:translateY(-4px); }
    .card h3 { margin:0;font-size:15px;color:#777;text-transform:uppercase; }
    .card p { margin:10px 0 0;font-size:22px;font-weight:bold;color:#111; }
    .done { border-top:4px solid #2ecc71; }
    .pending { border-top:4px solid #f39c12; }
    .bought { border-top:4px solid #9b59b6; }
    .available { border-top:4px solid #3498db; }
    h2 { margin:40px 0 15px; font-size:18px; color:#2c3e50; font-weight:600; }
    .table-wrapper { background:#fff;border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,0.08);overflow-x:auto; }
    table { width:100%; border-collapse:collapse; border-radius:16px; overflow:hidden; }
    th { background:#2c3e50;color:#fff;text-align:left;font-weight:500;padding:14px; }
    td { padding:14px; border-bottom:1px solid #eee; font-size:14px; }
    tr:nth-child(even) td { background:#f9f9f9; }
    .robux { font-weight:bold; color:#e74c3c; }
    .money { font-weight:bold; color:#27ae60; }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="navbar-left"><div class="icon-btn"><svg viewBox="0 0 24 24"><path d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z"/></svg></div></div>
    <div class="navbar-right"><div class="icon-btn" id="accountIcon">
      <svg viewBox="0 0 24 24"><path d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8V22h19.2v-2.8c0-3.2-6.4-4.8-9.6-4.8z"/></svg>
    </div></div>
  </div>
  <div id="dropdownBox"></div>
  <div class="container">
    <div class="grid">
      <div class="card done"><h3>ƒê∆°n h√†ng ho√†n th√†nh</h3><p id="doneOrders">0</p></div>
      <div class="card pending"><h3>ƒê∆°n h√†ng ƒëang ch·ªù</h3><p id="pendingOrders">0</p></div>
      <div class="card bought"><h3>Robux ƒë√£ mua</h3><p id="robuxBought">0</p></div>
      <div class="card available"><h3>Robux c√≥ s·∫µn</h3><p id="robuxAvailable">0</p></div>
    </div>
    <h2>Top mua Robux</h2>
    <div class="table-wrapper">
      <table id="ordersTable">
        <thead><tr><th>T√†i kho·∫£n</th><th>T·ªïng Robux</th><th>X·∫øp h·∫°ng</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <h2>L·ªãch s·ª≠ n·∫°p ti·ªÅn</h2>
    <div class="table-wrapper">
      <table id="depositsTable">
        <thead><tr><th>T√†i kho·∫£n</th><th>S·ªë ti·ªÅn n·∫°p</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, query, orderBy, limit, getDocs, doc, getDoc, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBbTe4CZM8mUqsJUyFBIjcSc3w4rvIbmzc",
      authDomain: "robuxvex.firebaseapp.com",
      projectId: "robuxvex",
      storageBucket: "robuxvex.firebasestorage.app",
      messagingSenderId: "291500837886",
      appId: "1:291500837886:web:08ae60ca6454c209328eaf",
      measurementId: "G-LWRKTMPXEN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    async function loadDashboard(){
      const uid = window.currentUid || localStorage.getItem('uid') || localStorage.getItem('userId');
      if (!uid) return;
      const q = query(
        collection(db,"orders"),
        where("uid","==", uid),
        orderBy("createdAt","desc"),
        limit(10)
      );
      const snapshot = await getDocs(q);
      let doneOrders = 0, pendingOrders = 0, robuxBought = 0;
      snapshot.forEach(docSnap=>{
        const data = docSnap.data();
        const amount = Number(data.robuxAmount || 0);
        if (data.status === "done") doneOrders++;
        if (data.status === "pending") pendingOrders++;
        robuxBought += amount;
      });
      document.getElementById("doneOrders").innerText = doneOrders;
      document.getElementById("pendingOrders").innerText = pendingOrders;
      document.getElementById("robuxBought").innerText = robuxBought;
      let totalRobuxAvailable = 0;
      snapshot.forEach(docSnap=>{ const data = docSnap.data(); if (data.status === "done") { totalRobuxAvailable += Number(data.robuxAmount || 0); } });
      document.getElementById("robuxAvailable").innerText = totalRobuxAvailable;
    }

    async function loadTopBuyers(){
      const q = query(collection(db, "orders"));
      const snapshot = await getDocs(q);
      const totals = {};
      snapshot.forEach(docSnap=>{
        const data = docSnap.data();
        const user = data.robloxUid || "Kh√¥ng r√µ";
        const amount = Number(data.robuxAmount || 0);
        if (!totals[user]) totals[user] = 0;
        totals[user] += amount;
      });
      const sorted = Object.entries(totals).sort((a,b)=>b[1]-a[1]).slice(0,4);
      const ordersBody = document.querySelector("#ordersTable tbody");
      ordersBody.innerHTML = "";
      sorted.forEach(([user,total],index)=>{
        ordersBody.insertAdjacentHTML("beforeend", `<tr><td>${user}</td><td class="robux">${total} R$</td><td>#${index+1}</td></tr>`);
      });
    }

    async function loadUserInfo(uid){
      const box = document.getElementById('dropdownBox');
      const fallbackAvatar = "https://i.postimg.cc/pV12TyXH/Screenshot-20250822-142636-Gallery.png";
      const ref = doc(db, "users", uid);
      const snap = await getDoc(ref);

      if(snap.exists()){
        const data = snap.data();
        const displayName = data.displayName || data.email?.split('@')[0] || 'Ng∆∞·ªùi d√πng';
        const balance = Number(data.balance || 0).toLocaleString('vi-VN');
        const totalDeposit = Number(data.totalDeposit || 0).toLocaleString('vi-VN');
        const role = data.role || 'Member';
        const avatar = data.avatar || fallbackAvatar;

        box.innerHTML = `
          <img src="${avatar}" alt="avatar" />
          <h3>${displayName}</h3>
          <div class="info-grid">
            <div class="info-box"><strong>${balance}ƒë</strong><p>S·ªë d∆∞</p></div>
            <div class="info-box"><strong>${totalDeposit}ƒë</strong><p>ƒê√£ n·∫°p</p></div>
            <div class="info-box"><strong>${role}</strong><p>Danh hi·ªáu</p></div>
          </div>
          <a href="#">‚öôÔ∏è C√†i ƒë·∫∑t</a>
          <a href="#" class="logout" id="logoutBtn">üö™ ƒêƒÉng xu·∫•t</a>`;
      } else {
        box.innerHTML = `
          <img src="${fallbackAvatar}" alt="avatar" />
          <h3>Ng∆∞·ªùi d√πng</h3>
          <div class="info-grid">
            <div class="info-box"><strong>0ƒë</strong><p>S·ªë d∆∞</p></div>
            <div class="info-box"><strong>0ƒë</strong><p>ƒê√£ n·∫°p</p></div>
            <div class="info-box"><strong>Member</strong><p>Danh hi·ªáu</p></div>
          </div>
          <a href="#">‚öôÔ∏è C√†i ƒë·∫∑t</a>
          <a href="#" class="logout" id="logoutBtn">üö™ ƒêƒÉng xu·∫•t</a>`;
      }

      const logoutBtn = document.querySelector('#logoutBtn');
      if (logoutBtn) logoutBtn.addEventListener('click', (e)=>{ e.preventDefault(); logout(); });
    }

    function toggleDropdown(){
      const box = document.getElementById('dropdownBox');
      const willShow = box.style.display !== 'block';
      box.style.display = willShow ? 'block' : 'none';
      if(willShow){
        const uid = window.currentUid || localStorage.getItem('uid') || localStorage.getItem('userId') || 'demo_uid';
        box.innerHTML = `<img src="https://i.postimg.cc/pV12TyXH/Screenshot-20250822-142636-Gallery.png" alt="avatar" /><h3>...</h3>`;
        loadUserInfo(uid);
      }
    }

    function logout(){
      localStorage.removeItem('uid'); 
      localStorage.removeItem('userId'); 
      localStorage.removeItem('username'); 
      localStorage.removeItem('name');
      document.getElementById('dropdownBox').style.display = 'none';
    }

    window.toggleDropdown = toggleDropdown;
    window.loadUserInfo = loadUserInfo;

    onAuthStateChanged(auth, (user)=>{ 
      if(user){ 
        window.currentUid = user.uid; 
        localStorage.setItem('uid', user.uid);
      } else { 
        const savedUid = localStorage.getItem('uid') || localStorage.getItem('userId'); 
        if(savedUid){ window.currentUid = savedUid; } 
      } 
    });

    document.addEventListener('DOMContentLoaded', ()=>{
      document.getElementById('accountIcon').addEventListener('click', toggleDropdown);
      loadDashboard();
      loadTopBuyers();
    });
  </script>
</body>
</html>
