<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ROBUXVEX - Dashboard</title>
  <style>
    body { margin:0; font-family:'Poppins',sans-serif; background:#f4f6fa; color:#333; }
    .navbar { position:fixed; top:0; left:0; right:0; height:60px; background:#fff; display:flex; align-items:center; justify-content:space-between; padding:0 20px; box-shadow:0 2px 10px rgba(0,0,0,0.1); z-index:1000; }
    .icon-btn { width:38px;height:38px;
:50%;background:#eee; display:flex;align-items:center;justify-content:center;cursor:pointer; }
    .icon-btn svg { width:20px;height:20px;fill:#333; }

    /* Dropdown tài khoản */
    #dropdownBox { position:fixed;top:65px;right:20px;background:#fff;border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.25);display:none;min-width:280px;padding:20px; z-index:1200; }
    #dropdownBox img { width:80px;height:80px;border-radius:50%;display:block;margin:0 auto 10px;border:4px solid #3498db;box-shadow:0 0 15px rgba(52,152,219,0.6);transition:all 0.3s ease; }
    #dropdownBox h3 { text-align:center;margin:5px 0 15px; }
    .info-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; text-align:center; margin-bottom:15px; }
    .info-box { background:#f9f9f9;padding:10px;border-radius:12px;box-shadow:inset 0 0 8px rgba(0,0,0,0.05);transition:0.3s; }
    .info-box:hover { background:#eef7ff; box-shadow:0 0 12px rgba(52,152,219,0.4); }
    .info-box p { margin:4px 0; font-size:13px; }
    .info-box strong { font-size:14px; display:block; }
    #dropdownBox a { display:block;padding:10px 14px;color:#333;text-decoration:none;border-radius:8px;margin-top:5px;text-align:center; }
    #dropdownBox a:hover { background:#f4f6fa; }
    #dropdownBox .logout { color:#e74c3c;font-weight:600; }
    /* LED viền đỏ-cam cho số tiền & robux */
.led-box {
  display: inline-block;
  padding: 6px 12px;
  border-radius: 12px;
  font-weight: bold;
  color: #fff;
  background: linear-gradient(90deg, #ff0000, #ff8800);
  box-shadow: 0 0 12px rgba(255,0,0,0.8),
              0 0 20px rgba(255,136,0,0.9);
  animation: glowPulse 1.5s infinite alternate;
}
#ordersTable, #depositsTable {
  border-collapse: collapse;
  width: 100%;
}

#ordersTable th, #ordersTable td,
#depositsTable th, #depositsTable td {
  text-align: center;
  padding: 12px;
  border: 1px solid #ddd; /* đường kẻ ngăn cách */
}

#ordersTable th, #depositsTable th {
  background: #2c3e50;
  color: #fff;
}

#ordersTable tr:nth-child(even) td,
#depositsTable tr:nth-child(even) td {
  background: #f9f9f9;
}
/* LED xanh dương-xanh lá cho tên user */
.led-name {
  display: inline-block;
  padding: 3px 8px;
  border-radius: 10px;
  color: #fff;
  font-weight: 600;
  background: linear-gradient(90deg, #00aaff, #00ff66);
  box-shadow: 0 0 10px rgba(0,170,255,0.8),
              0 0 18px rgba(0,255,100,0.9);
  animation: namePulse 2s infinite alternate;
}
#ordersTable th, #ordersTable td,
#depositsTable th, #depositsTable td {
  text-align: center;
}
/* Hiệu ứng nhấp nháy nhẹ */
@keyframes glowPulse {
  from { box-shadow: 0 0 10px rgba(255,0,0,0.7), 0 0 20px rgba(255,136,0,0.8); }
  to   { box-shadow: 0 0 18px rgba(255,0,0,1),   0 0 30px rgba(255,136,0,1); }
}

@keyframes namePulse {
  from { box-shadow: 0 0 8px rgba(0,170,255,0.7), 0 0 14px rgba(0,255,100,0.8); }
  to   { box-shadow: 0 0 16px rgba(0,170,255,1),  0 0 26px rgba(0,255,100,1); }
}
.top-section {
  background: #fff;
  border-radius: 16px;
  padding: 20px;
  margin: 25px 0;
  box-shadow: 0 0 20px rgba(0, 200, 255, 0.2);
  position: relative;
  overflow: hidden;
}
  
/* viền ngoài phát sáng nhẹ */
.top-section::before {
  content: "";
  position: absolute;
  inset: 0;
  border-radius: 16px;
  padding: 2px; /* độ dày viền */
  background: linear-gradient(135deg, #00aaff, #00ff88, #ff6600);
  -webkit-mask: 
     linear-gradient(#fff 0 0) content-box, 
     linear-gradient(#fff 0 0);
  -webkit-mask-posite: xor;
  mask-composite: exclude;
  animation: borderGlow 3s linear infinite;
}

@keyframes borderGlow {
  0% { filter: hue-rotate(0deg); }
  100% { filter: hue-rotate(360deg); }
}
    .section-title {
  font-size: 20px;
  font-weight: 700;
  text-align: center;
  padding: 10px 18px;
  margin: 35px auto 15px;
  color: #fff;
  display: inline-block;
  border-radius: 12px;
  background: linear-gradient(90deg, #0066ff, #00ff99);
  box-shadow: 0 0 10px rgba(0,255,150,0.7), 0 0 20px rgba(0,120,255,0.9);
  text-shadow: 0 0 5px #fff, 0 0 12px rgba(0,200,255,0.8);
  animation: softPulse 2s infinite alternate;
}

/* hiệu ứng nhấp nháy nhẹ */
@keyframes softPulse {
  from { box-shadow: 0 0 8px rgba(0,255,150,0.6), 0 0 18px rgba(0,120,255,0.7); }
  to   { box-shadow: 0 0 14px rgba(0,255,150,0.8), 0 0 28px rgba(0,120,255,0.9); }
}
    /* Main */
    .container { padding:80px 20px 40px; max-width:1200px; margin:auto; }
    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:20px; }
    .card { background:#fff;border-radius:16px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.08); text-align:center;transition:transform 0.2s; }
    .card:hover { transform:translateY(-4px); }
    .card h3 { margin:0;font-size:15px;color:#777;text-transform:uppercase; }
    .card p { margin:10px 0 0;font-size:22px;font-weight:bold;color:#111; }
    .done { border-top:4px solid #2ecc71; }
    .pending { border-top:4px solid #f39c12; }
    .bought { border-top:4px solid #9b59b6; }
    .available { border-top:4px solid #3498db; }
    h2 { margin:40px 0 15px; font-size:18px; color:#2c3e50; font-weight:600; }
    .table-wrapper { background:#fff;border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,0.08);overflow-x:auto; }
    table { width:100%; border-collapse:collapse; border-radius:16px; overflow:hidden; }
    th { background:#2c3e50;color:#fff;text-align:left;font-weight:500;padding:14px; }
    td { padding:14px; border-bottom:1px solid #eee; font-size:14px; }
    tr:nth-child(even) td { background:#f9f9f9; }
    .robux { font-weight:bold; color:#e74c3c; }
    .money { font-weight:bold; color:#27ae60; }

    /* Sidebar */
    #sidebar {
      position:fixed;top:0;left:-260px;width:260px;height:100%;
      background:#0b1e45;color:#fff;
      box-shadow:2px 0 12px rgba(0,0,0,0.2);
      transition:left 0.3s ease; z-index:1100; padding:20px 0;
    }
    #sidebar.active { left:0; }
    #sidebar h3 { padding:0 20px;margin-bottom:20px;font-size:18px;color:#ddd; }
    #sidebar ul { list-style:none; padding:0; margin:0; }
    #sidebar ul li { margin:8px 0; }
    #sidebar ul li a {
      display:flex;align-items:center;
      padding:10px 20px;color:#fff;text-decoration:none;font-size:15px;
      transition:background 0.2s;
    }
    #sidebar ul li a:hover { background:rgba(255,255,255,0.1); border-radius:6px; }
    #sidebar ul li a svg { margin-right:12px; width:18px;height:18px;fill:#fff; }
    #overlay {
      position:fixed;top:0;left:0;width:100%;height:100%;
      background:rgba(0,0,0,0.4);display:none;z-index:1000;
    }
    #overlay.active { display:block; }







/* ===== Dropdown Glass Neon ===== */
#dropdownBox {
  position: absolute;
  top: 65px;
  right: 15px;
  width: 300px;
  padding: 22px;
  border-radius: 20px;
  background: rgba(255,255,255,0.08);
  backdrop-filter: blur(15px);
  border: 1px solid rgba(255,255,255,0.25);
  box-shadow: 0 8px 35px rgba(0,0,0,0.5),
              0 0 25px rgba(0,198,255,0.4);
  text-align: center;
  display: none;
  animation: fadeIn 0.3s ease-in-out;
  color: #fff;
  z-index: 999;
}

/* Avatar Neon Glow */
#dropdownBox img.user-avatar {
  width: 95px;
  height: 95px;
  border-radius: 50%;
  object-fit: cover;
  border: 3px solid #00c6ff;
  box-shadow: 0 0 25px rgba(0,198,255,0.8), 
              0 0 40px rgba(0,198,255,0.5);
  margin-bottom: 12px;
  animation: pulseGlow 3s infinite ease-in-out;
}

/* User Name Gradient */
#dropdownBox h3.user-name {
  font-size: 21px;
  font-weight: bold;
  margin-bottom: 18px;
  background: linear-gradient(90deg, #00c6ff, #7f00ff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: 0 0 6px rgba(0,198,255,0.6);
}

/* Info Grid Neon */
#dropdownBox .info-grid {
  display: flex;
  justify-content: space-between;
  gap: 10px;
  margin-bottom: 18px;
}

#dropdownBox .info-box {
  flex: 1;
  padding: 14px 10px;
  border-radius: 14px;
  font-size: 14px;
  background: linear-gradient(145deg, rgba(0,198,255,0.18), rgba(127,0,255,0.15));
  border: 1px solid rgba(255,255,255,0.25);
  box-shadow: 
    0 0 18px rgba(0,198,255,0.25),
    0 0 30px rgba(127,0,255,0.15),
    inset 0 0 8px rgba(255,255,255,0.05);
  color: #fff;
  font-weight: 600;
  text-shadow: 0 1px 2px rgba(0,0,0,0.7);
}

#dropdownBox .info-box strong {
  display: block;
  font-size: 17px;
  font-weight: 800;
  color: #fff;
  text-shadow: 0 0 4px rgba(0,198,255,0.9), 0 0 6px rgba(0,198,255,0.5);
}

#dropdownBox .info-box p {
  margin: 6px 0 0;
  font-size: 13px;
  color: #e0e0e0;
  text-shadow: 0 1px 2px rgba(0,0,0,0.6);
}

/* Buttons Neon */
#dropdownBox .user-actions {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

#dropdownBox .btn-action {
  display: block;
  padding: 13px;
  border-radius: 14px;
  font-size: 15px;
  font-weight: bold;
  text-decoration: none;
  text-align: center;
  transition: all 0.25s ease-in-out;
  letter-spacing: 0.5px;
  color: #fff;
  text-shadow: 0 1px 2px rgba(0,0,0,0.8);
}

#dropdownBox .btn-action.profile {
  background: linear-gradient(270deg,#00c6ff,#0072ff,#00c6ff);
  background-size: 300% 300%;
  animation: gradientMove 6s infinite linear;
  box-shadow: 0 0 25px rgba(0,198,255,0.8);
}

#dropdownBox .btn-action.logout {
  background: linear-gradient(270deg,#ff416c,#ff4b2b,#ff416c);
  background-size: 300% 300%;
  animation: gradientMove 6s infinite linear;
  box-shadow: 0 0 25px rgba(255,65,108,0.8);
}

#dropdownBox .btn-action:hover {
  transform: translateY(-3px) scale(1.03);
  box-shadow: 0 0 35px rgba(255,255,255,0.9),
              0 0 45px rgba(0,198,255,0.6);
}

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-12px) scale(0.95); }
  to   { opacity: 1; transform: translateY(0) scale(1); }
}

@keyframes pulseGlow {
  0%,100% { box-shadow: 0 0 20px rgba(0,198,255,0.8), 0 0 40px rgba(0,198,255,0.4); }
  50%     { box-shadow: 0 0 30px rgba(127,0,255,0.9), 0 0 50px rgba(127,0,255,0.5); }
}

@keyframes gradientMove {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}












  </style>
</head>
<body>
  <!-- NAVBAR -->
  <div class="navbar">
    <div class="navbar-left">
      <!-- Hamburger menu chính -->
      <div class="icon-btn" id="menuBtn">
        <svg viewBox="0 0 24 24"><path d="M3 6h18v2H3V6zm0 5h18v2H3v-2zm0 5h18v2H3v-2z"/></svg>
      </div>
    </div>
    <div class="navbar-right">
      <div class="icon-btn" id="accountIcon">
        <svg viewBox="0 0 24 24"><path d="M12 12c2.7 0 4.8-2.1 4.8-4.8S14.7 2.4 12 2.4 7.2 4.5 7.2 7.2 9.3 12 12 12zm0 2.4c-3.2 0-9.6 1.6-9.6 4.8V22h19.2v-2.8c0-3.2-6.4-4.8-9.6-4.8z"/></svg>
      </div>
    </div>
  </div>

  <!-- DROPDOWN ACCOUNT -->
  <div id="dropdownBox"></div>

  <!-- DASHBOARD -->
  <div class="container">
    <div class="grid">
      <div class="card done"><h3>Đơn hàng hoàn thành</h3><p id="doneOrders">0</p></div>
      <div class="card pending"><h3>Đơn hàng đang chờ</h3><p id="pendingOrders">0</p></div>
      <div class="card bought"><h3>Robux đã mua</h3><p id="robuxBought">0</p></div>
      <div class="card available"><h3>Robux có sẵn</h3><p id="robuxAvailable">8932</p></div>
    </div>

   <div class="top-section">
  <div class="section-title">🌟 TOP MUA ROBUX (WEB) 🌟</div>
  <div class="table-wrapper">
    <table id="ordersTable">    <thead><tr><th>Tài khoản</th><th>Tổng Robux</th><th>Thời gian</th></tr></thead>
        <tbody></tbody></table>
  </div>
</div>
 
 <div class="top-section">
  <div class="section-title">💸 TOP NẠP TIỀN 💸</div>
  <div class="table-wrapper">
    <table id="depositsTable">        <thead><tr><th>Tài khoản</th><th>Số tiền nạp</th></tr></thead>
        <tbody></tbody></table>
  </div>
</div>
 
 






  <!-- SIDEBAR -->
  <div id="sidebar">
    
    

    <h3>CHỨC NĂNG CHÍNH</h3>

     <ul>
      <li><a href="https://robuxvex.vercel.app"><svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>Trang chủ</a></li>
     </ul>
    
    <ul>
      <li><a href="muahang.html"><svg viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zm0-2h14V6H7v10zm13-12c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H7c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h13z"/></svg>Mua robux</a></li>
      <li><a href="lichsumuarobux"><svg viewBox="0 0 24 24"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm1 17.9V20h-2v-.1C7.1 19.4 4 16 4 12c0-4 3.1-7.4 7-7.9V4h2v.1c3.9.5 7 3.9 7 7.9 0 4-3.1 7.4-7 7.9z"/></svg>Lịch sử mua hàng</a></li>
    </ul>

    <h3>TÀI KHOẢN & NẠP</h3>
    <ul>
      <li><a href="nap.html"><svg viewBox="0 0 24 24"><path d="M12 8c-2.2 0-4 1.8-4 4s1.8 4 4 4 4-1.8 4-4-1.8-4-4-4zm0-6C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2z"/></svg>Nạp tiền</a></li>
      <li><a href="#"><svg viewBox="0 0 24 24"><path d="M3 3h18v2H3V3zm0 6h18v2H3V9zm0 6h18v2H3v-2z"/></svg>Cộng tác viên (chưa mở)</a></li>
    </ul>

    <h3>HỖ TRỢ KHÁCH HÀNG</h3>
    <ul>
      <li><a href="zalo.me/0907486634"><svg viewBox="0 0 24 24"><path d="M22 12c0-5.5-4.5-10-10-10S2 6.5 2 12c0 4.7 3.2 8.6 7.5 9.7v-6.9H7.1V12h2.4V9.8c0-2.4 1.4-3.8 3.6-3.8 1 0 2.1.2 2.1.2v2.4h-1.2c-1.2 0-1.6.7-1.6 1.5V12h2.7l-.4 2.8h-2.3v6.9C18.8 20.6 22 16.7 22 12"/></svg>ZALO</a></li>
      <li><a href="mailto:vochuoi86@gmail.com"><svg viewBox="0 0 24 24"><path d="M10 15.5l6-3.5-6-3.5v7zM12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2z"/></svg>Gửi mail</a></li>
    </ul>
  </div>

  <div id="overlay"></div>

  <!-- FIX: chỉ 1 hamburger & toggle sidebar -->
  <script>
    (function(){
      var sidebar = document.getElementById('sidebar');
      var overlay = document.getElementById('overlay');
      var menuBtn = document.getElementById('menuBtn');
      if (!sidebar || !menuBtn) return;
      function toggleSidebar(){
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
      }
      menuBtn.onclick = toggleSidebar;
      overlay.onclick = toggleSidebar;
    })();
  </script>

  <!-- Firebase + Dashboard -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getFirestore, collection, query, orderBy, limit, getDocs, doc, getDoc, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBbTe4CZM8mUqsJUyFBIjcSc3w4rvIbmzc",
    authDomain: "robuxvex.firebaseapp.com",
    projectId: "robuxvex",
    storageBucket: "robuxvex.firebasestorage.app",
    messagingSenderId: "291500837886",
    appId: "1:291500837886:web:08ae60ca6454c209328eaf",
    measurementId: "G-LWRKTMPXEN"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  function asMillis(v){
    if (!v) return null;
    if (typeof v === "number") return v;
    if (typeof v === "string") { const d = new Date(v); return isNaN(d) ? null : d.getTime(); }
    if (v.toDate) { try { return v.toDate().getTime(); } catch { return null; } }
    if (v instanceof Date) return v.getTime();
    return null;
  }

  // ===== Dashboard số liệu =====
  async function loadDashboard(){
    const user = auth.currentUser;
    if (!user) return;
    const q = query(collection(db,"orders"), where("uid","==", user.uid), orderBy("createdAt","desc"), limit(10));
    const snapshot = await getDocs(q);
    let doneOrders = 0, pendingOrders = 0, robuxBought = 0, totalRobuxAvailable = 2000;

    snapshot.forEach(docSnap=>{
      const data = docSnap.data();
      const amount = Number(data.robuxAmount || 0);
      const s = String(data.status||"").toLowerCase();
      if (s === "completed") { doneOrders++; totalRobuxAvailable += amount; }
      if (s === "pending") pendingOrders++;
      robuxBought += amount;
    });

    document.getElementById("doneOrders").innerText = doneOrders;
    document.getElementById("pendingOrders").innerText = pendingOrders;
    document.getElementById("robuxBought").innerText = robuxBought;
    document.getElementById("robuxAvailable").innerText = totalRobuxAvailable;
  }

  // ===== Lấy tên user từ uid =====
  async function getUserName(uid){
    if (!uid) return "Người dùng";
    const ref = doc(db, "users", uid);
    const snap = await getDoc(ref);
    if (snap.exists()) return snap.data().displayName || uid;
    return uid;
  }

  // ===== TOP Buyer =====
  async function loadTopBuyers(){
    const q = query(collection(db, "orders"));
    const snapshot = await getDocs(q);
    const userData = {};

    snapshot.forEach(docSnap=>{
      const d = docSnap.data();
      const uid = d.uid;
      const amount = Number(d.robuxAmount || 0);
      if (!uid) return;
      if (!userData[uid]) userData[uid] = { total:0, latestMs:null };
      userData[uid].total += amount;

      const msDelivered = asMillis(d.deliveredAT || d.deliveredAt);
      const msCreated   = asMillis(d.createdAt);
      const ms = msDelivered ?? msCreated;
      if (ms !== null && (userData[uid].latestMs === null || ms > userData[uid].latestMs)) {
        userData[uid].latestMs = ms;
      }
    });

    const userNames = {};
    await Promise.all(Object.keys(userData).map(async uid => {
      userNames[uid] = await getUserName(uid);
    }));

    const sorted = Object.entries(userData).sort((a,b)=>b[1].total - a[1].total).slice(0,4);
    const ordersBody = document.querySelector("#ordersTable tbody");
    ordersBody.innerHTML = "";

    sorted.forEach(([uid, data])=>{
      const name = userNames[uid] || "Người dùng";
      const timeStr = data.latestMs
        ? `<span class="time-cell" data-timestamp="${data.latestMs}"></span>`
        : "";
      ordersBody.insertAdjacentHTML("beforeend", `
        <tr>
          <td><span class="led-name">${name}</span></td>
          <td><span class="led-box">${data.total} R$</span></td>
          <td>${timeStr}</td>
        </tr>
      `);
    });

    refreshTimes();
  }

  // ===== TOP Nạp tiền =====
  async function loadTopDeposits(){
    const q = query(collection(db, "napthe"));
    const snapshot = await getDocs(q);
    const totals = {};
    snapshot.forEach(docSnap=>{
      const d = docSnap.data();
      const uid = d.uid;
      const amount = Number(d.amount || 0);
      if (!uid) return;
      if (!totals[uid]) totals[uid] = 0;
      totals[uid] += amount;
    });
    const userNames = {};
    await Promise.all(Object.keys(totals).map(async uid => {
      userNames[uid] = await getUserName(uid);
    }));
    const sorted = Object.entries(totals).sort((a,b)=>b[1]-a[1]).slice(0,5);
    const depositsBody = document.querySelector("#depositsTable tbody");
    depositsBody.innerHTML = "";
    sorted.forEach(([uid, total])=>{
      depositsBody.insertAdjacentHTML("beforeend", `
        <tr>
          <td><span class="led-name">${userNames[uid] || uid}</span></td>
          <td><span class="led-box">${total.toLocaleString('vi-VN')}đ</span></td>
        </tr>
      `);
    });
  }

  // ===== Dropdown user info =====
  function toggleDropdown(){
    const box = document.getElementById('dropdownBox');
    const willShow = box.style.display !== 'block';
    box.style.display = willShow ? 'block' : 'none';
    if (willShow && auth.currentUser) loadUserInfo(auth.currentUser);
  }

  async function loadUserInfo(user){
  const box = document.getElementById('dropdownBox');
  const fallbackAvatar = "https://i.postimg.cc/pV12TyXH/Screenshot-20250822-142636-Gallery.png";
  const ref = doc(db, "users", user.uid);
  const snap = await getDoc(ref);

  let displayName = user.displayName || user.email?.split('@')[0] || "Người dùng";
  let balance = "0", totalDeposit = "0", role = "Member";
  let avatar = user.photoURL || fallbackAvatar;

  if (snap.exists()){
    const data = snap.data();
    displayName = data.displayName || displayName;
    balance = Number(data.balance || 0).toLocaleString('vi-VN');
    totalDeposit = Number(data.totalDeposit || 0).toLocaleString('vi-VN');
    role = data.role || role;
    avatar = data.avatar || avatar;
  }

  // 💎 Dropdown HTML lung linh
  box.innerHTML = `
    <img src="${avatar}" alt="avatar" class="user-avatar" />
    <h3 class="user-name">${displayName}</h3>
    
    <div class="info-grid">
      <div class="info-box"><strong>${balance}đ</strong><p>Số dư</p></div>
      <div class="info-box"><strong>${totalDeposit}đ</strong><p>Đã nạp</p></div>
      <div class="info-box"><strong>${role}</strong><p>Vai trò</p></div>
    </div>

    <div class="user-actions">
      <a href="profile.html" class="btn-action profile">👤 Hồ sơ</a>
      <a href="#" class="btn-action logout" id="logoutBtn">🚪 Đăng xuất</a>
    </div>
  `;

  // 🚪 Logout event
  document.getElementById('logoutBtn').addEventListener('click', async (e)=>{
    e.preventDefault();
    await signOut(auth);
    window.location.href = "login.html";
  });
}

  // ===== Time Ago =====
  function timeAgo(ms){
    const s = Math.floor((Date.now() - ms)/1000);
    if (s < 60) return s + " giây trước";
    const m = Math.floor(s/60);
    if (m < 60) return m + " phút trước";
    const h = Math.floor(m/60);
    if (h < 24) return h + " giờ trước";
    const d = Math.floor(h/24);
    return d + " ngày trước";
  }

  function refreshTimes(){
    document.querySelectorAll('.time-cell').forEach(el=>{
      const ts = parseInt(el.dataset.timestamp,10);
      if (!isNaN(ts)) el.textContent = timeAgo(ts);
    });
  }
  setInterval(refreshTimes, 60000);

  // ===== Auth state =====
  onAuthStateChanged(auth, (user)=>{
    if(user){
      loadDashboard();
      loadTopBuyers();
      loadTopDeposits();
    } else {
      window.location.href = "login.html";
    }
  });

  document.getElementById("accountIcon").addEventListener("click", toggleDropdown);
</script>
<script>
ument.getElementById('dropdownBox').style.display = 'none';
        location.reload();
      });
    }

    // Expose nếu cần dùng ở ngoài
    window.toggleDropdown = toggleDropdown;

    // Khi đăng nhập xong
    onAuthStateChanged(auth, (user)=>{ 
      if(user){ 
        window.currentUid = user.uid; 
        localStorage.setItem('uid', user.uid);
        loadDashboard();
        loadTopBuyers();
        loadTopDeposits();
      } 
    });

    // Gán click cho icon người dùng
    document.addEventListener('DOMContentLoaded', ()=>{
      const acc = document.getElementById('accountIcon');
      if (acc) acc.addEventListener('click', toggleDropdown);
    });
  </script>
<script> 
function timeAgo(ms){
  const seconds = Math.floor((Date.now() - ms) / 1000);
  if (seconds < 60) return `${seconds} giây trước`;
  const minutes = Math.floor(seconds/60);
  if (minutes < 60) return `${minutes} phút trước`;
  const hours = Math.floor(minutes/60);
  if (hours < 24) return `${hours} giờ trước`;
  const days = Math.floor(hours/24);
  return `${days} ngày trước`;
}

function refreshTimes(){
  document.querySelectorAll('.time-cell').forEach(td=>{
    const ts = parseInt(td.dataset.timestamp);
    if (!isNaN(ts)) td.textContent = timeAgo(ts);
  });
}

// cập nhật ngay và sau đó tự động mỗi 60 giây
setInterval(refreshTimes, 60000);
</script>
</body>
</html>
