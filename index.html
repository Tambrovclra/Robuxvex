<!DOCTYPE html>
<html lang="vi" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ROBUXVEX ‚Ä¢ Dashboard</title>

  <style>
    /* ===== THEME TOKENS ===== */
    :root{
      --bg:#0b1220;
      --panel:#0f172a;
      --panel-2:#111a2e;
      --muted:#92a0b3;
      --text:#e6eefc;
      --brand:#4f8cff;
      --brand-2:#7c5cff;
      --accent:#00d2a8;
      --danger:#ff5d6c;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --ringGrad: conic-gradient(
        from 0deg,
        #ff3d81, #ff914d, #ffd93d, #7bff3d, #3dffea, #3d79ff, #a43dff, #ff3df2, #ff3d81
      );
    }
    [data-theme="light"]{
      --bg:#f5f7fb;
      --panel:#ffffff;
      --panel-2:#f9fbff;
      --muted:#5c6b7e;
      --text:#0f172a;
      --brand:#2b6cff;
      --brand-2:#7c5cff;
      --accent:#06b6d4;
      --danger:#ef4444;
      --shadow:0 8px 24px rgba(0,0,0,.08);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue","Noto Sans","Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1000px 1000px at -10% -20%, rgba(79,140,255,.15), transparent 40%),
        radial-gradient(800px 800px at 110% 10%, rgba(124,92,255,.15), transparent 40%),
        var(--bg);
      -webkit-tap-highlight-color: transparent;
    }

    /* ===== REMOVE BLUE OUTLINE (theo y√™u c·∫ßu) ===== */
    a:focus, button:focus, [tabindex]:focus, .icon-btn:focus, .nav-link:focus{
      outline:none !important; box-shadow:none !important;
    }
    :focus-visible{ outline:none !important; box-shadow:none !important; }

    /* ===== NAVBAR ===== */
    .navbar{
      position: sticky; top:0; z-index: 50;
      height:64px; padding:0 16px;
      display:flex; align-items:center; justify-content:space-between;
      backdrop-filter:saturate(180%) blur(12px);
      background: linear-gradient(180deg, rgba(15,23,42,.85), rgba(15,23,42,.55));
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    [data-theme="light"] .navbar{
      background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.55));
      border-bottom: 1px solid rgba(15,23,42,.06);
    }
    .nav-left{display:flex; align-items:center; gap:12px}
    .logo-wrap{display:flex; align-items:center; gap:10px}
    .logo{height:36px; width:auto; border-radius:10px; box-shadow: var(--shadow)}
    .brand-title{font-weight:700; letter-spacing:.4px}
    .icon-btn{
      width:40px; height:40px; display:grid; place-items:center; border-radius:12px;
      background:#0c152a; border:1px solid rgba(255,255,255,.06); cursor:pointer;
      transition:.2s transform,.2s background,.2s border-color,.2s opacity;
    }
    .icon-btn:hover{ transform: translateY(-1px); background:#0e1832; border-color:rgba(255,255,255,.12)}
    [data-theme="light"] .icon-btn{ background:#eef2ff; border-color:rgba(15,23,42,.06)}
    [data-theme="light"] .icon-btn:hover{ background:#e6ecff; border-color:rgba(15,23,42,.12)}
    .icon{width:22px; height:22px; stroke:#c9d6ea; fill:none; stroke-width:2}
    [data-theme="light"] .icon{ stroke:#334155 }

    .wrap{ max-width:1200px; margin:24px auto; padding:0 16px}

    /* ===== BREADCRUMB / SUBTITLE LINK ===== */
    .crumb{
      margin:8px 0 16px; font-size:14px; letter-spacing:.2px; display:flex; align-items:center; gap:8px;
      color:var(--muted);
    }
    .crumb a{
      color:var(--text); text-decoration:none; font-weight:700; padding:6px 10px; border-radius:10px;
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border:1px solid rgba(255,255,255,.06);
    }
    [data-theme="light"] .crumb a{ border-color: rgba(15,23,42,.06) }

    /* ===== GRID KPI ===== */
    .grid-4{
      display:grid; gap:16px;
      grid-template-columns: repeat(4, minmax(0,1fr));
    }
    @media (max-width: 1024px){ .grid-4{grid-template-columns: repeat(2, minmax(0,1fr));} }
    @media (max-width: 640px){ .grid-4{grid-template-columns: 1fr;} }

    /* ===== CARDS ===== */
    .card{
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border: 1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
      position:relative; overflow:hidden;
    }
    [data-theme="light"] .card{ border-color: rgba(15,23,42,.06) }

    .card::after{
      content:""; position:absolute; inset:-1px; border-radius:calc(var(--radius) + 1px);
      padding:1px;
      background: linear-gradient(135deg, rgba(79,140,255,.35), rgba(0,210,168,.25), rgba(124,92,255,.35));
      -webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude; opacity:.35; pointer-events:none;
    }
    .kpi{ display:flex; align-items:center; justify-content:space-between; gap:16px; }
    .kpi h4{margin:0; font-size:12px; text-transform:uppercase; color:var(--muted); letter-spacing:.8px}
    .kpi .val{font-size:24px; font-weight:800; margin-top:8px}
    .pill{
      padding:10px 12px; border-radius:12px; display:flex; align-items:center; gap:8px;
      background:#0c152a; border: 1px solid rgba(255,255,255,.06)
    }
    [data-theme="light"] .pill{ background:#eef2ff; border-color:rgba(15,23,42,.06) }

    /* ===== SECTIONS (TOP TABLES) ===== */
    .section{
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border: 1px solid rgba(255,255,255,.06); border-radius: var(--radius); box-shadow: var(--shadow);
      overflow:hidden; position:relative;
    }
    [data-theme="light"] .section{ border-color: rgba(15,23,42,.06) }
    .section-head{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:16px 18px; border-bottom:1px solid rgba(255,255,255,.06);
      background: linear-gradient(180deg, rgba(79,140,255,.08), transparent);
    }
    [data-theme="light"] .section-head{ border-bottom-color: rgba(15,23,42,.06) }
    .section-title{ margin:0; font-size:15px; letter-spacing:.4px }
    .badge{
      font-size:12px; color:#0b1220; background: linear-gradient(90deg, var(--brand), var(--accent));
      padding:6px 10px; border-radius:999px; font-weight:700;
    }

    /* ===== TABLE ===== */
    .table-wrap{ overflow:auto }
    table{ width:100%; border-collapse:collapse; }
    thead th{
      text-align:left; font-weight:600; letter-spacing:.3px; color:#bcd0ee; font-size:12px;
      padding:12px 16px; background: rgba(255,255,255,.03)
    }
    [data-theme="light"] thead th{ color:#334155; background: rgba(15,23,42,.03) }
    tbody td{ padding:14px 16px; border-top:1px dashed rgba(255,255,255,.06) }
    [data-theme="light"] tbody td{ border-top-color: rgba(15,23,42,.08) }
    tbody tr:hover td{ background: rgba(79,140,255,.06) }
    [data-theme="light"] tbody tr:hover td{ background: rgba(43,108,255,.08) }
    .name{font-weight:700}
    .chip{
      display:inline-block; padding:6px 10px; border-radius:10px; font-weight:700; letter-spacing:.3px;
      background: rgba(79,140,255,.12); color:#bed6ff; border:1px solid rgba(79,140,255,.35)
    }
    [data-theme="light"] .chip{ color:#1e40af; background: rgba(43,108,255,.12); border-color: rgba(43,108,255,.35) }
    .time{ color:#9fb2cf; font-size:12px }
    [data-theme="light"] .time{ color:#475569 }

    /* ===== SIDEBAR ===== */
    .sidebar{
      position:fixed; inset:0 auto 0 0; width:280px; transform: translateX(-100%);
      background: linear-gradient(180deg, #0e1529, #0e182f);
      border-right:1px solid rgba(255,255,255,.06); z-index: 60; transition:.25s transform;
      box-shadow: var(--shadow); display:flex; flex-direction:column;
    }
    [data-theme="light"] .sidebar{ background: #fff; border-right-color: rgba(15,23,42,.06) }
    .sidebar.active{ transform: translateX(0) }
    .side-head{ padding:16px 16px 8px; color:#bcd0ee; font-weight:700; letter-spacing:.4px }
    [data-theme="light"] .side-head{ color:#334155 }
    .nav-list{ list-style:none; padding:6px 8px 16px; margin:0; display:grid; gap:6px }
    .nav-link{
      display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; color:var(--text); text-decoration:none;
      border:1px solid rgba(255,255,255,.06); background:#0c152a; transition:.2s;
    }
    [data-theme="light"] .nav-link{ background:#f8fafc; border-color: rgba(15,23,42,.06) }
    .nav-link:hover{ background:#0f1c39; border-color: rgba(255,255,255,.12)}
    [data-theme="light"] .nav-link:hover{ background:#eef2ff; border-color: rgba(15,23,42,.12) }
    .nav-ico{ width:18px; height:18px; stroke:#c9d6ea; fill:none; stroke-width:2 }
    [data-theme="light"] .nav-ico{ stroke:#334155 }

    .overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:55; display:none;
    }
    .overlay.active{ display:block }

    /* ===== ACCOUNT DROPDOWN ===== */
    .dropdown{
      position: fixed; top:74px; right:16px; maxwidth:320px; display:none; z-index:60;
      background: linear-gradient(180deg, #0f1a33, #0d172e);
      border:1px solid rgba(255,255,255,.08); border-radius:18px; box-shadow: var(--shadow);
      overflow:hidden;
    }
    [data-theme="light"] .dropdown{
      background:#ffffff; border-color: rgba(15,23,42,.08);
    }
    .drop-head{ padding:16px; display:grid; gap:12px; text-align:center;
      background: radial-gradient(800px 200px at 50% -20%, rgba(79,140,255,.25), transparent 60%);
      border-bottom:1px solid rgba(255,255,255,.06)
    }
    [data-theme="light"] .drop-head{ border-bottom-color: rgba(15,23,42,.06) }
    .avatar{ width:84px; height:84px; border-radius:50%; object-fit:cover; margin:0 auto; border:2px solid rgba(79,140,255,.5) }
    .who{ margin:0; font-size:18px; font-weight:800 }
    .kv{ display:grid; grid-auto-flow: column; gap:10px; justify-content:center }
    .kv .box{
      padding:10px 12px; border-radius:12px; background:#0c152a; border:1px solid rgba(255,255,255,.06); min-width:88px;
    }
    [data-theme="light"] .kv .box{ background:#f1f5f9; border-color: rgba(15,23,42,.06) }
    .kv .box .v{ font-weight:800 }
    .drop-actions{ padding:14px; display:grid; gap:10px }
    .btn{
      display:block; text-align:center; text-decoration:none; padding:12px 14px; border-radius:12px; font-weight:800; letter-spacing:.3px;
      border:1px solid rgba(255,255,255,.06); transition:.2s transform,.2s background,.2s border-color;
    }
    .btn:hover{ transform: translateY(-1px) }
    .btn-grad-1{ background: linear-gradient(90deg, var(--brand), var(--brand-2)); }
    .btn-grad-2{ background: linear-gradient(90deg, var(--accent), #24e2d2); color:#0b1220 }
    .btn-ghost{ background:#0c152a }
    [data-theme="light"] .btn-ghost{ background:#eef2ff; border-color: rgba(15,23,42,.08) }
    .btn-danger{ background: linear-gradient(90deg, #ff5d6c, #ff8963) }

    /* ===== SMALL UTILITIES ===== */
    .sr{ color:var(--muted); font-size:12px }

    /* ===== TWO TOP SECTIONS SIDE-BY-SIDE ===== */
    .top-grid{
      margin-top:28px;
      display:grid; gap:18px;
      grid-template-columns: 1fr 1fr;
      align-items:stretch;
    }
    @media (max-width: 900px){ .top-grid{ grid-template-columns: 1fr; } }

    /* ===== RAINBOW LED RING WRAP ===== */
    .led-wrap{
      position:relative; border-radius: calc(var(--radius) + 10px);
      padding:10px;
    }
    .led-wrap::before{
      content:""; position:absolute; inset:0; border-radius:inherit; padding:2px;
      background: var(--ringGrad);
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude;
      
    }
    .led-wrap::after{
      /* bright moving dot */
      content:""; position:absolute; width:14px; height:14px; border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff, #ffd93d 50%, transparent 70%);
      top: -7px; left: 50%; transform: translateX(-50%);
      box-shadow: 0 0 18px 6px rgba(255,255,255,.7), 0 0 36px 12px rgba(124,92,255,.55);
      animation: orbit 4s linear infinite;
      pointer-events:none;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes orbit {
      0%   { transform: translate(-50%, 0) rotate(0deg) translateY(0); }
      25%  { transform: translate(-50%, 0) rotate(90deg) translateY(0); }
      50%  { transform: translate(-50%, 0) rotate(180deg) translateY(0); }
      75%  { transform: translate(-50%, 0) rotate(270deg) translateY(0); }
      100% { transform: translate(-50%, 0) rotate(360deg) translateY(0); }
    }


    .rbx-bar {
    width: 6px; height: 20px; border-radius: 4px;
    background: linear-gradient(135deg,#6a11cb,#2575fc);
    }
  </style>
</head>
<body>

  <!-- NAVBAR -->
  <header class="navbar">
    <div class="nav-left">
      <button class="icon-btn" id="openSidebar" title="Menu">
        <svg class="icon" viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      </button>
      <div class="logo-wrap">
        <img class="logo" src="https://i.postimg.cc/Vs4sX62s/file-0000000025b061f780c5334d2cfcad87.png" alt="ROBUXVEX">
        <div class="brand-title">ROBUXVEX</div>
      </div>
    </div>
    <div class="nav-right" style="display:flex; gap:10px; align-items:center">
      <!-- N√∫t ch·∫ø ƒë·ªô s√°ng/t·ªëi (tr√°i icon ng∆∞·ªùi) -->
      <button class="icon-btn" id="btnTheme" title="Ch·∫ø ƒë·ªô s√°ng/t·ªëi">
        <svg class="icon" id="icoTheme" viewBox="0 0 24 24">
          <!-- default moon -->
          <path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>
        </svg>
      </button>
      <button class="icon-btn" id="btnAccount" title="T√†i kho·∫£n">
        <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"></circle><path d="M4 20c0-4 4-6 8-6s8 2 8 6"></path></svg>
      </button>
    </div>
  </header>

  <!-- SIDEBAR -->
  <aside class="sidebar" id="sidebar">
    <div class="side-head">ƒêi·ªÅu h∆∞·ªõng</div>
    <ul class="nav-list">
      <li><a class="nav-link" href="https://robuxvex.vercel.app">
        <svg class="nav-ico" viewBox="0 0 24 24"><path d="M3 12l9-9 9 9"></path><path d="M9 21V9h6v12"></path></svg>
        Trang ch·ªß
      </a></li>
      <li><a class="nav-link" href="muahang.html">
        <svg class="nav-ico" viewBox="0 0 24 24"><path d="M6 6h15l-1.5 9H8L6 6z"></path><circle cx="9" cy="20" r="1"></circle><circle cx="18" cy="20" r="1"></circle></svg>
        Mua Robux
      </a></li>
      <li><a class="nav-link" href="nap.html">
        <svg class="nav-ico" viewBox="0 0 24 24"><path d="M12 3v18"></path><path d="M6 12h12"></path><circle cx="12" cy="12" r="9"></circle></svg>
        N·∫°p ti·ªÅn
      </a></li>
      <li><a class="nav-link" href="lichsumuarobux">
        <svg class="nav-ico" viewBox="0 0 24 24"><path d="M3 4h18M8 2v4M16 2v4"></path><rect x="3" y="8" width="18" height="12" rx="2"></rect><path d="M7 12h10M7 16h7"></path></svg>
        L·ªãch s·ª≠ mua h√†ng
      </a></li>
    </ul>

    <div class="side-head">H·ªó tr·ª£</div>
    <ul class="nav-list">
      <li><a class="nav-link" href="zalo.me/0907486634">
        <svg class="nav-ico" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M10 8h4v8h-4z"></path></svg>
        Zalo
      </a></li>
      <li><a class="nav-link" href="mailto:vochuoi86@gmail.com">
        <svg class="nav-ico" viewBox="0 0 24 24"><path d="M4 4h16v16H4z"></path><path d="M22 6l-10 7L2 6"></path></svg>
        G·ª≠i mail
      </a></li>
    </ul>
  </aside>
  <div class="overlay" id="overlay"></div>

  <!-- ACCOUNT DROPDOWN -->
  <div class="dropdown" id="dropdown"></div>

  <!-- CONTENT -->
  <main class="wrap">
    <!-- Subtitle / breadcrumb: Trang ch·ªß -->
    <div class="crumb">
      <a href="index.html" id="linkHome">Trang ch·ªß</a>
      <span class="sr"></span>
    </div>

    <!-- KPIs -->
    <section class="grid-4">
      <div class="card">
        <div class="kpi">
          <div>
            <h4>ƒê∆°n ho√†n th√†nh</h4>
            <div class="val" id="doneOrders">0</div>
          </div>
          <div class="pill"><svg class="icon" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg> <span class="sr">Done</span></div>
        </div>
      </div>
      <div class="card">
        <div class="kpi">
          <div>
            <h4>ƒê∆°n ƒëang ch·ªù</h4>
            <div class="val" id="pendingOrders">0</div>
          </div>
          <div class="pill"><svg class="icon" viewBox="0 0 24 24"><path d="M12 6v6l4 2"></path></svg> <span class="sr">Pending</span></div>
        </div>
      </div>
      <div class="card">
        <div class="kpi">
          <div>
            <h4>Robux ƒë√£ mua</h4>
            <div class="val" id="robuxBought">0</div>
          </div>
          <div class="pill"><svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="8"></circle><path d="M12 8v8M8 12h8"></path></svg> <span class="sr">Bought</span></div>
        </div>
      </div>
      <div class="card">
        <div class="kpi">
          <div>
            <h4>Robux c√≥ s·∫µn</h4>
            <div class="val" id="robuxAvailable">7,152</div>
          </div>
          <div class="pill"><svg class="icon" viewBox="0 0 24 24"><path d="M20 6H4v12h16z"></path><path d="M16 10H8v4h8z"></path></svg> <span class="sr">Stock</span></div>
        </div>
      </div>
    </section>

    <!-- TWO TOP BOXES SIDE BY SIDE WITH LED RING -->
    <div class="togrid">
      <div class="led-wrap">
        <section class="section">
          <div class="section-head">
              <h3 class="section-title">TOP mua Robux (Web)</h3>
            <span class="badge">Realtime</span>
          </div>
          <div class="table-wrap">
            <table id="ordersTable">
              <thead>
                <tr><th>T√†i kho·∫£n</th><th>T·ªïng Robux</th><th>Th·ªùi gian</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>

      <div class="led-wrap">
        <section class="section">
          <div class="section-head">
            <h3 class="section-title">TOP n·∫°p ti·ªÅn</h3>
            <span class="badge">24h g·∫ßn ƒë√¢y</span>
          </div>
          <div class="table-wrap">
            <table id="depositsTable">
              <thead>
                <tr><th>T√†i kho·∫£n</th><th>S·ªë ti·ªÅn n·∫°p</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </section>
      </div>
    </div>
  </main>
  <!-- BEHAVIOR: sidebar -->
  <script>
    (function(){
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('overlay');
      const openSidebar = document.getElementById('openSidebar');
      function toggle(){
        sidebar.classList.toggle('active');
        overlay.classList.toggle('active');
      }
      openSidebar.addEventListener('click', toggle);
      overlay.addEventListener('click', toggle);
    })();

    // Theme toggle (s√°ng/t·ªëi)
    (function(){
      const root = document.documentElement;
      const btn = document.getElementById('btnTheme');
      const ico = document.getElementById('icoTheme');
      const saved = localStorage.getItem('theme');
      if (saved === 'light' || saved === 'dark') {
        root.setAttribute('data-theme', saved);
        if (saved === 'light') ico.innerHTML = '<circle cx="12" cy="12" r="5"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>';
      }
      btn.addEventListener('click', ()=>{
        const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        root.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
        if (next === 'light'){
          ico.innerHTML = '<circle cx="12" cy="12" r="5"></circle><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>';
        } else {
          ico.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3a7 7 0 0 0 9.79 9.79z"></path>';
        }
      });
    })();
  </script>

  <!-- FIREBASE + DATA -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, query, orderBy, limit, getDocs, doc, getDoc, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // ==== Firebase config (gi·ªØ nh∆∞ file tr∆∞·ªõc c·ªßa b·∫°n) ====
    const firebaseConfig = {
      apiKey: "AIzaSyBbTe4CZM8mUqsJUyFBIjcSc3w4rvIbmzc",
      authDomain: "robuxvex.firebaseapp.com",
      projectId: "robuxvex",
      storageBucket: "robuxvex.firebasestorage.app",
      messagingSenderId: "291500837886",
      appId: "1:291500837886:web:08ae60ca6454c209328eaf",
      measurementId: "G-LWRKTMPXEN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ===== Utils =====
    const $ = (sel) => document.querySelector(sel);
    function asMillis(v){
      if (!v) return null;
      if (typeof v === "number") return v;
      if (typeof v === "string"){
        const d = new Date(v); return isNaN(d) ? null : d.getTime();
      }
      if (v instanceof Date) return v.getTime();
      if (typeof v === "object" && typeof v.toDate === "function"){
        try { return v.toDate().getTime(); } catch { return null; }
      }
      return null;
    }
    function timeAgo(ms){
      if (!ms) return "";
      const s = Math.floor((Date.now() - ms)/1000);
      if (s < 60) return `${s}s tr∆∞·ªõc`;
      const m = Math.floor(s/60);
      if (m < 60) return `${m} ph√∫t tr∆∞·ªõc`;
      const h = Math.floor(m/60);
      if (h < 24) return `${h} gi·ªù tr∆∞·ªõc`;
      const d = Math.floor(h/24);
      return `${d} ng√†y tr∆∞·ªõc`;
    }
    function refreshTimes(){
      document.querySelectorAll("[data-ts]").forEach(el=>{
        const ms = Number(el.getAttribute("data-ts"));
        el.textContent = timeAgo(ms);
      });
    }
    setInterval(refreshTimes, 60_000);

    // ===== Auth dropdown =====
    const dropdown = $("#dropdown");
    $("#btnAccount").addEventListener("click", ()=>{
      const visible = dropdown.style.display === "block";
      dropdown.style.display = visible ? "none" : "block";
      if (!visible) renderAccountBox();
    });
    document.addEventListener("click",(e)=>{
      const btn = $("#btnAccount");
      if (dropdown.style.display==="block" && !dropdown.contains(e.target) && !btn.contains(e.target)){
        dropdown.style.display="none";
      }
    });

    async function getUserName(uid){
      if (!uid) return "Ng∆∞·ªùi d√πng";
      const ref = doc(db,"users",uid);
      const s = await getDoc(ref);
      if (s.exists()) return s.data().displayName || uid;
      return uid;
    }

    async function renderAccountBox(){
      const user = auth.currentUser;
      if (!user){
        dropdown.innerHTML = `
          <div class="drop-head">
            <h4 class="who">B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p</h4>
            <div class="sr">ƒêƒÉng nh·∫≠p ƒë·ªÉ theo d√µi ƒë∆°n & s·ªë d∆∞</div>
          </div>
          <div class="drop-actions">
            <a class="btn btn-grad-2" href="dk.html">üìù ƒêƒÉng k√Ω</a>
            <a class="btn btn-grad-1" href="dn.html">üîë ƒêƒÉng nh·∫≠p</a>
          </div>
        `;
        return;
      }
      const ref = doc(db,"users",user.uid);
      const s = await getDoc(ref);
      const data = s.exists() ? s.data() : {};
      const name = data.displayName || user.displayName || (user.email ? user.email.split("@")[0] : "Ng∆∞·ªùi d√πng");
      const balance = Number(data.balance || 0).toLocaleString("vi-VN");
      const deposited = Number(data.totalDeposit || 0).toLocaleString("vi-VN");
      const role = data.role || "Member";
      const avatar = data.avatar || user.photoURL || "https://i.postimg.cc/pV12TyXH/Screenshot-20250822-142636-Gallery.png";

      dropdown.innerHTML = `
        <div class="drop-head">
          <img class="avatar" src="${avatar}" alt="${name}" />
          <h3 class="who">${name}</h3>
          <div class="kv">
            <div class="box"><div class="v">${balance}ƒë</div><div class="sr">S·ªë d∆∞</div></div>
            <div class="box"><div class="v">${deposited}ƒë</div><div class="sr">ƒê√£ n·∫°p</div></div>
            <div class="box"><div class="v">${role}</div><div class="sr">Vai tr√≤</div></div>
          </div>
        </div>
        <div class="drop-actions">
          <a class="btn btn-ghost" href="profile.html">üë§ H·ªì s∆°</a>
          <a class="btn btn-danger" id="btnLogout" href="#">üö™ ƒêƒÉng xu·∫•t</a>
        </div>
      `;
      $("#btnLogout")?.addEventListener("click", async (e)=>{
        e.preventDefault();
        await signOut(auth);
        dropdown.style.display="none";
        location.reload();
      });
    }

    // ===== Dashboard numbers (only when logged-in) =====
    async function loadDashboard(){
      const u = auth.currentUser;
      if (!u) {
        // v·∫´n hi·ªÉn th·ªã Robux c√≥ s·∫µn = 7152 d√π ch∆∞a ƒëƒÉng nh·∫≠p
        document.getElementById('robuxAvailable').textContent = (7152).toLocaleString('vi-VN');
        return;
      }
      const qy = query(
        collection(db,"orders"),
        where("uid","==",u.uid),
        orderBy("createdAt","desc"),
        limit(50)
      );
      const s = await getDocs(qy);
      let done=0, pending=0, bought=0;
      s.forEach(d=>{
        const v = d.data();
        const st = String(v.status||"").toLowerCase();
        const amt = Number(v.robuxAmount||0);
        if (st==="completed") done++;
        if (st==="pending") pending++;
        bought += amt;
      });
      document.getElementById("doneOrders").textContent = done;
      document.getElementById("pendingOrders").textContent = pending;
      document.getElementById("robuxBought").textContent = bought;

      // Theo y√™u c·∫ßu: Robux c√≥ s·∫µn = 7152 (c·ªë ƒë·ªãnh)
      document.getElementById("robuxAvailable").textContent = (7152).toLocaleString('vi-VN');
    }

    // ===== TOP Buyers (always load, no login required) =====
    async function loadTopBuyers(){
      const qy = query(collection(db,"orders"));
      const s = await getDocs(qy);

      const map = new Map(); // uid -> {total, latest}
      s.forEach(docSnap=>{
        const v = docSnap.data();
        const uid = v.uid; if (!uid) return;
        const amt = Number(v.robuxAmount||0);
        const ms = asMillis(v.deliveredAT || v.deliveredAt || v.createdAt);
        if (!map.has(uid)) map.set(uid,{total:0, latest: ms ?? 0});
        const cur = map.get(uid);
        cur.total += amt;
        if (ms && ms > cur.latest) cur.latest = ms;
      });

      // resolve names
      const entries = Array.from(map.entries());
      const names = {};
      await Promise.all(entries.map(async([uid])=>{
        names[uid] = await getUserName(uid);
      }));

      const top = entries.sort((a,b)=> b[1].total - a[1].total).slice(0,5);
      const tb = document.querySelector("#ordersTable tbody");
      tb.innerHTML = "";
      top.forEach(([uid,info])=>{
        tb.insertAdjacentHTML("beforeend", `
          <tr>
            <td class="name">${names[uid] || uid}</td>
            <td><span class="chip">${(info.total||0).toLocaleString('vi-VN')} R$</span></td>
            <td class="time" data-ts="${info.latest||''}">${info.latest? timeAgo(info.latest):""}</td>
          </tr>
        `);
      });
      refreshTimes();
    }

    // ===== TOP Deposits (always load, no login required) =====
    async function loadTopDeposits(){
      const qy = query(collection(db,"napthe"));
      const s = await getDocs(qy);
      const sum = new Map(); // uid -> total money
      s.forEach(d=>{
        const v = d.data();
        const uid = v.uid; if (!uid) return;
        const money = Number(v.amount||0);
        sum.set(uid, (sum.get(uid)||0) + money);
      });

      const entries = Array.from(sum.entries());
      const names = {};
      await Promise.all(entries.map(async([uid])=>{
        names[uid] = await getUserName(uid);
      }));

      const top = entries.sort((a,b)=> b[1]-a[1]).slice(0,5);
      const tb = document.querySelector("#depositsTable tbody");
      tb.innerHTML = "";
      top.forEach(([uid,total])=>{
        tb.insertAdjacentHTML("beforeend", `
          <tr>
            <td class="name">${names[uid] || uid}</td>
            <td><span class="chip">${total.toLocaleString('vi-VN')}ƒë</span></td>
          </tr>
        `);
      });
    }

    // ===== Init =====
    loadTopBuyers();
    loadTopDeposits();
    onAuthStateChanged(auth, (user)=>{
      if (user){ loadDashboard(); }
      else { document.getElementById('robuxAvailable').textContent = (7152).toLocaleString('vi-VN'); }
    });
  </script>
</body>
</html>
