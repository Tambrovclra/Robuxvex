<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mua robux - ROBUXVEX</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    /* ===== THEME LIGHT ===== */
    :root{
      --bg:#f5f7fb;
      --panel:#ffffff;
      --panel-2:#f9fbff;
      --muted:#5c6b7e;
      --text:#0f172a;
      --brand:#2b6cff;
      --brand-2:#7c5cff;
      --accent:#06b6d4;
      --danger:#ef4444;
      --shadow:0 8px 24px rgba(0,0,0,.08);
      --radius:18px;
      --navy:#0d2338;
      --line:#e6e9ee;
    }
    body{margin:0;font-family:Inter,system-ui,sans-serif;color:var(--text);background:var(--bg);}
    *{box-sizing:border-box}

    /* ===== NAVBAR ===== */
    .navbar{
      position: sticky; top:0; z-index: 50;
      height:64px; padding:0 16px;
      display:flex; align-items:center; justify-content:space-between;
      background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.85));
      border-bottom: 1px solid rgba(15,23,42,.06);
      backdrop-filter:saturate(180%) blur(12px);
    }
    .nav-left{display:flex; align-items:center; gap:12px}
    .logo{height:36px; width:auto; border-radius:10px}
    .brand-title{font-weight:700; font-size:18px; color:var(--text);}
    .icon-btn{
      width:40px; height:40px; display:grid; place-items:center; border-radius:12px;
      background:#eef2ff; border:1px solid rgba(15,23,42,.06); cursor:pointer;
    }
    .icon{width:22px; height:22px; stroke:#334155; fill:none; stroke-width:2}

    /* ===== SIDEBAR ===== */
    .sidebar{position:fixed;inset:0 auto 0 0;width:280px;transform:translateX(-100%);
      background:#fff;border-right:1px solid rgba(15,23,42,.06);
      z-index:60;transition:.25s transform;box-shadow:var(--shadow);display:flex;flex-direction:column;}
    .sidebar.active{transform:translateX(0)}
    .side-head{padding:16px;color:#334155;font-weight:700}
    .nav-list{list-style:none;padding:6px 8px 16px;margin:0;display:grid;gap:6px}
    .nav-link{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;
      color:var(--text);text-decoration:none;border:1px solid rgba(15,23,42,.06);background:#f8fafc}
    .nav-link:hover{background:#eef2ff;border-color:rgba(15,23,42,.12)}
    .nav-link svg {width:18px;height:18px;stroke:#334155;}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:55;display:none}
    .overlay.active{display:block}

    /* ===== CONTENT ===== */
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px;display:grid;gap:20px}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));
      border:1px solid rgba(15,23,42,.06);border-radius:var(--radius);padding:20px}

    label{display:block;margin:10px 0 6px;font-size:14px;font-weight:700;color:var(--muted)}
    .input-glow, select{
      width:100%;padding:12px;border-radius:12px;border:2px solid rgba(124,58,237,.6);
      outline:none;background:#fff;color:#111;
    }

    .summary{display:flex;justify-content:space-between;align-items:center;
      background:#f9fafb;border:1px solid #ddd;border-radius:12px;
      padding:12px 16px;margin-bottom:10px;font-weight:700;}
    .summary span:last-child{font-size:18px;color:#e11d48;font-weight:800;}

    .btn{
      display:block;width:100%;padding:14px;border:none;border-radius:14px;
      font-size:16px;font-weight:800;cursor:pointer;
      background:linear-gradient(90deg,var(--brand),var(--brand-2));color:#fff;
    }
    .btn:disabled{opacity:.5;cursor:not-allowed}

    .warning{margin-top:10px;font-size:14px;font-weight:700;padding:10px;border-radius:8px;display:none;}
    .warning.error{background:#fee2e2;color:#991b1b;}
    .warning.success{background:#d1fae5;color:#065f46;}

    /* ===== GRID LAYOUT ===== */
    @media(min-width: 960px){
      .grid-2 {display:grid;grid-template-columns:1fr 1fr;gap:20px;}
    }

    /* ===== HƯỚNG DẪN ===== */
    .guide-card h3{font-size:18px;font-weight:800;margin-bottom:10px;color:#4f46e5;display:flex;gap:6px;align-items:center;}
    .guide-card ol{margin-left:20px;}
    .guide-card ol li{margin-bottom:8px;font-weight:600;color:#374151;}
    .guide-note{margin-top:10px;padding:10px;border-left:4px solid #fbbf24;background:#fffbeb;border-radius:6px;font-size:14px;font-style:italic;color:#92400e;}

    /* ===== TABLE STYLE ===== */
    .table-card{
      background:var(--card,#fff);
      border-radius:12px;
      box-shadow:0 6px 18px rgba(16,24,40,0.06);
      overflow:hidden;
      border:1px solid rgba(15,23,42,0.03);
    }
    .card-head{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;font-weight:800;font-size:15px;color:var(--text);}
    .card-head .title{display:flex;align-items:center;gap:12px;text-transform:uppercase;letter-spacing:0.6px}
    .card-head .title::before{content:"";width:6px;height:22px;border-radius:3px;display:block;background: linear-gradient(180deg, #ef4444 0%, #7c3aed 100%);}
    .table-wrap{width:100%;overflow-x:auto;padding:0 16px 18px;}
    table{width:100%;border-collapse:collapse;font-size:14px;table-layout:auto;min-width:720px}
    thead{background:var(--navy);color:#fff}
    thead th{padding:12px 14px;text-align:left;font-weight:700;font-size:13px;border-bottom:3px solid #fff;border-right:1px solid #fff;white-space:nowrap}
    thead th:last-child{border-right:none}
    tbody td{padding:14px;color:var(--text);border-top:1px solid var(--line);border-right:1px solid var(--line);vertical-align:middle}
    tbody td:last-child{border-right:none}
    tbody tr:hover td{background:#fbfdff}

    /* ===== CHIPS ===== */
    .chip{
      display:inline-block;
      padding:4px 10px;
      border-radius:20px;
      font-size:13px;
      font-weight:700;
      color:#fff;
      white-space:nowrap;
    }
    .chip.username{background:linear-gradient(90deg,#2563eb,#7c3aed);}
    .chip.type{background:linear-gradient(90deg,#f97316,#dc2626);}
    .chip.price{background:linear-gradient(90deg,#facc15,#065f46);}
    .chip.status-pending{background:linear-gradient(90deg,#facc15,#f97316);}
    .chip.status-failed{background:linear-gradient(90deg,#dc2626,#6d28d9);}
    .chip.status-completed{background:linear-gradient(90deg,#4ade80,#15803d);}
    
    
    
    
    .guide-card ol li{
  margin-bottom:6px;
  font-weight:500;
  font-size:14px;  /* nhỏ lại */
  line-height:1.5;
}
.guide-card h3{
  font-size:16px;
}
.guide-note{
  font-size:13px;
}
    
    
    
    
  </style>
</head>
<body>

<!-- NAVBAR -->
<header class="navbar">
  <div class="nav-left">
    <button class="icon-btn" id="openSidebar" title="Menu">
      <svg class="icon" viewBox="0 0 24 24">
        <line x1="3" y1="6" x2="21" y2="6"/>
        <line x1="3" y1="12" x2="21" y2="12"/>
        <line x1="3" y1="18" x2="21" y2="18"/>
      </svg>
    </button>
    <div class="logo-wrap" style="display:flex;align-items:center;gap:10px;">
      <img class="logo" src="https://i.postimg.cc/Vs4sX62s/file-0000000025b061f780c5334d2cfcad87.png" alt="ROBUXVEX">
      <div class="brand-title">ROBUXVEX</div>
    </div>
  </div>
</header>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="side-head">Điều hướng</div>
  <ul class="nav-list">
    <li><a class="nav-link" href="index.html">
      <svg viewBox="0 0 24 24" fill="none"><path d="M3 12l9-9 9 9" stroke="currentColor" stroke-width="2"/><path d="M9 21V9h6v12" stroke="currentColor" stroke-width="2"/></svg>
      Trang chủ</a></li>
    <li><a class="nav-link" href="muahang.html">
      <svg viewBox="0 0 24 24" fill="none"><path d="M3 3h18v4H3zM3 7h18l-2 14H5z" stroke="currentColor" stroke-width="2"/></svg>
      Mua Robux</a></li>
    <li><a class="nav-link" href="nap.html">
      <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/><path d="M8 12h8M12 8v8" stroke="currentColor" stroke-width="2"/></svg>
      Nạp tiền</a></li>
    <li><a class="nav-link" href="lichsu.html">
      <svg viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/><path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2"/></svg>
      Lịch sử mua hàng</a></li>
  </ul>
  <div class="side-head">Hỗ trợ</div>
  <ul class="nav-list">
    <li><a class="nav-link" href="zalo.me/0907486634">
      <svg viewBox="0 0 24 24" fill="none"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="currentColor" stroke-width="2"/></svg>
      Zalo</a></li>
    <li><a class="nav-link" href="mailto:vochuoi86@gmail.com">
      <svg viewBox="0 0 24 24" fill="none"><path d="M4 4h16v16H4z" stroke="currentColor" stroke-width="2"/><path d="M4 4l8 8 8-8" stroke="currentColor" stroke-width="2"/></svg>
      Email</a></li>
  </ul>
</aside>
<div class="overlay" id="overlay"></div>

<!-- CONTENT -->
<main class="wrap">
  <!-- GRID FORM + GUIDE -->
  <div class="grid-2">
    <!-- FORM MUA -->
    <div class="card">
      <label for="type">Chọn loại</label>
      <select id="type" class="input-glow">
        <option value="gamepass">Gamepass</option>
        <option value="giftcard">Gift Card</option>
      </select>

      <label for="username">Roblox Username</label>
      <input id="username" class="input-glow" placeholder="Nhập username...">

      <label for="contact">Liên hệ của bạn</label>
      <input id="contact" class="input-glow" placeholder="Nhập Gmail, Zalo...">

      <label for="qty">Số lượng (Robux)</label>
      <input type="number" id="qty" class="input-glow" value="60" min="1">

      <div class="summary"><span>Tổng thanh toán</span><span id="total">0 ₫</span></div>
      <div class="summary" id="afterTaxRow"><span>Thực nhận</span><span id="afterTax">0 R$</span></div>

      <button class="btn" id="buyBtn">⚡ Mua Ngay ⚡</button>
      <div id="warningBox" class="warning"></div>
    </div>

    <!-- HƯỚNG DẪN -->
    <div class="card guide-card">
      <h3>📑 Hướng dẫn mua Robux</h3>
      <ol>
        <li>Chọn loại giao dịch (Gamepass hoặc Gift Card).</li>
        <li>Điền username Roblox và thông tin liên hệ.</li>
        <li>Nhập số Robux cần mua (Gift Card mặc định 400 R$).</li>
        <li>Tạo gamepass đúng mệnh giá nếu chọn Gamepass.</li>
        <li>Nhấn <b>Mua Ngay</b> và chờ duyệt.</li>
      </ol>
      <div class="guide-note">💡 Lưu ý: Mua qua Gamepass thực nhận chỉ = 70% do phí Roblox.</div>

      <img src="https://i.postimg.cc/2y2hRYsZ/Screenshot-20250829-201639-Gallery.png" 
  
     style="width:90%; max-width:550px; margin-top:16px; border-radius:12px; display:block; margin-left:auto; margin-right:auto;">
    </div>
  </div>

  <!-- LỊCH SỬ MUA HÀNG -->
  <section class="table-card" aria-label="Lịch sử mua hàng">
    <div class="card-head">
      <div class="title">Lịch sử mua hàng</div>
      <div class="meta">Gần đây</div>
    </div>
    <div class="table-wrap">
      <table id="historyTable">
        <thead>
          <tr>
            <th>Username</th>
            <th>Type</th>
            <th>Robux Amount</th>
            <th>After Tax</th>
            <th>Price</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>
</main>

<script>
  // sidebar toggle
  const sidebar=document.getElementById('sidebar');
  const overlay=document.getElementById('overlay');
  document.getElementById('openSidebar').onclick=()=>{sidebar.classList.toggle('active');overlay.classList.toggle('active');}
  overlay.onclick=()=>{sidebar.classList.remove('active');overlay.classList.remove('active');}
</script>






<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, collection, addDoc, query, orderBy, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";





    const firebaseConfig = {
      apiKey: "AIzaSyBbTe4CZM8mUqsJUyFBIjcSc3w4rvIbmzc",
      authDomain: "robuxvex.firebaseapp.com",
      projectId: "robuxvex",
      storageBucket: "robuxvex.firebasestorage.app",
      messagingSenderId: "291500837886",
      appId: "1:291500837886:web:08ae60ca6454c209328eaf",
      measurementId: "G-LWRKTMPXEN"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    let currentUser = null;



    const qtyInput = document.getElementById("qty");
    const totalEl = document.getElementById("total");
    const afterTaxEl = document.getElementById("afterTax");
    const afterTaxRow = document.getElementById("afterTaxRow");
    const buyBtn = document.getElementById("buyBtn");
    const usernameInput = document.getElementById("username");
    const contactInput = document.getElementById("contact");
    const typeSelect = document.getElementById("type");
    const warningBox = document.getElementById("warningBox");
    const historyTableBody = document.getElementById("historyTable").querySelector("tbody");

    const PRICE_PER_ROBUX = 10000 / 60;

    function showWarning(msg, type="error") {
      warningBox.style.display = "block";
      warningBox.className = "warning " + type;
      warningBox.textContent = msg;
    }

    function updateForm() {
      if (typeSelect.value === "giftcard") {
        qtyInput.value = 400;
        qtyInput.disabled = true;
        afterTaxRow.querySelector('span:first-child').textContent = 'Mệnh giá';
      } else {
        qtyInput.disabled = false;
        afterTaxRow.querySelector('span:first-child').textContent = 'Thực nhận';
      }
      updateTotal();
    }

    function updateTotal() {
      const qty = parseInt(qtyInput.value) || 0;
      let price = 0;
      let robuxAfter = 0;

      if (typeSelect.value === "giftcard") {
        price = 100000;
        robuxAfter = qty; // giftcard không trừ 30%
      } else {
        price = Math.round(qty * PRICE_PER_ROBUX);
        robuxAfter = Math.floor(qty * 0.7);
      }

      totalEl.innerText = price.toLocaleString("vi-VN") + " ₫";
      afterTaxEl.innerText = robuxAfter + " R$";

      buyBtn.disabled = !(usernameInput.value.trim().length >= 3 && contactInput.value.trim().length >= 3 && qty > 0);
    }

    async function handleBuy(username, contact, robux, priceVND) {
      if (!currentUser) {
        showWarning("❌ Bạn cần đăng nhập trước khi mua!", "error");
        return;
      }

      const userRef = doc(db, "users", currentUser.uid);
      const snap = await getDoc(userRef);
      if (!snap.exists()) {
        showWarning("❌ Tài khoản của bạn chưa được khởi tạo trong hệ thống!", "error");
        return;
      }

      const balance = parseInt(snap.data().balance) || 0;
      if (balance < priceVND) {
        showWarning("❌ Số dư không đủ! Số dư hiện tại: " + balance.toLocaleString("vi-VN") + "₫", "error");
        return;
      }

      await updateDoc(userRef, { balance: balance - priceVND });

      await addDoc(collection(db, "orders"), {
        uid: currentUser.uid,
        robloxName: username,
        contact,
        robux,
        robuxAmount: (typeSelect.value === "giftcard" ? robux : Math.floor(robux * 0.7)),
        price: priceVND,
        createdAt: new Date().toISOString(),
        deliveredAt: null,
        type: typeSelect.value,
        status: "pending"
      });

      showWarning(`✅ Mua thành công ${robux} R$ cho @${username}. Số dư còn lại: ${(balance - priceVND).toLocaleString("vi-VN")}₫`, "success");
    }

    function addHistoryRow(doc) {
  const data = doc.data();
  const tr = document.createElement("tr");

  let statusClass = "status-pending";
  if (data.status === "completed") {
    statusClass = "status-completed";
  } else if (data.status === "failed") {
    statusClass = "status-failed";
  }

  tr.innerHTML = `
    <td><span class="chip username">${data.robloxName || "N/A"}</span></td>
    <td><span class="chip type">${data.type || "-"}</span></td>
    <td>${data.robux || 0} R$</td>
    <td>${data.robuxAmount || 0} R$</td>
    <td><span class="chip price">${(data.price || 0).toLocaleString("vi-VN")}₫</span></td>
    <td><span class="chip ${statusClass}">${data.status || "-"}</span></td>
  `;

  document.querySelector("#historyTable tbody").appendChild(tr);
}

    function loadHistory() {
      if (!currentUser) return;
      const q = query(
        collection(db, "orders"),
        where("uid", "==", currentUser.uid),
        orderBy("createdAt", "desc")
      );
      onSnapshot(q, (snapshot) => {
  historyTableBody.innerHTML = "";
  snapshot.forEach((doc) => {
    addHistoryRow(doc);
  });
});
    }

    typeSelect.addEventListener("change", updateForm);
    qtyInput.addEventListener("input", updateTotal);
    usernameInput.addEventListener("input", updateTotal);
    contactInput.addEventListener("input", updateTotal);

    buyBtn.addEventListener("click", () => {
      const username = usernameInput.value.trim();
      const contact = contactInput.value.trim();
      const robux = parseInt(qtyInput.value);
      const priceVND = (typeSelect.value === "giftcard") ? 100000 : Math.round(robux * PRICE_PER_ROBUX);
      handleBuy(username, contact, robux, priceVND);
    });

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if (currentUser) {
        loadHistory();
      } else {
        historyTableBody.innerHTML = "<tr><td colspan='7'>⚠️ Vui lòng đăng nhập để xem lịch sử mua hàng</td></tr>";
      }
    });

    updateForm();
    document.getElementById("buyBtn").addEventListener("click", async () => {
  const username = document.getElementById("username").value.trim();
  const contact = document.getElementById("contact").value.trim();
  const robuxAmount = parseInt(document.getElementById("qty").value) || 0;
  const type = document.getElementById("type").value; // 👈 lấy Gamepass | Giftcard

  if (!username || !contact || robuxAmount <= 0) {
    alert("Vui lòng nhập đầy đủ thông tin!");
    return;
  }

  // Tính toán
  const afterTax = type === "gamepass" ? Math.floor(robuxAmount * 0.7) : robuxAmount;
  const price = robuxAmount * 350; // bạn chỉnh công thức giá theo ý

  // Lưu vào Firestore
  await addDoc(collection(db, "orders"), {
    username,
    contact,
    robuxAmount,
    afterTax,
    price,
    type,                // 👈 thêm type vào đây
    status: "pending",
    createdAt: serverTimestamp()
  });

  alert("Đặt mua thành công!");
});
    </script>






<script>
import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js";

const messaging = getMessaging(app);

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/firebase-messaging-sw.js')
    .then(async (reg) => {
      console.log('Service worker registered:', reg);

      const permission = await Notification.requestPermission();
      if (permission === 'granted') {
        const token = await getToken(messaging, {
          vapidKey: "BOkDyfOxTnVK_DvD3yslB8JWcPXHi2REidV9-BHpZmZBJ4g9W-KbmHZPSSLZq8VsPx473XC2uXYsw6DJr0GUWso" // 👈 lấy trong Firebase Console
        });
        console.log("🔑 Token:", token);

        // Hiện token ra UI để dễ copy
        const el = document.createElement('textarea');
        el.value = token || "Không lấy được token";
        el.style.width = "100%";
        el.style.height = "80px";
        document.body.prepend(el);
      }
    });
}


<!-- Firebase script giữ nguyên -->

</script>
</body>
</html>

