<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mua Robux bằng Thẻ Cào | RobuxVEX</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-image: url('https://i.postimg.cc/tRtmYJHd/Screenshot-20250729-192919-Gallery.png');
      background-size: cover;
      background-position: center;
      backdrop-filter: blur(3px);
    }
    .form-wrapper {
      max-width: 400px;
      margin: 80px auto;
      background: url('https://i.postimg.cc/P5HHYrXz/Pngtree-shining-vast-fantasy-universe-cloud-1445881.png') center/cover;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
      color: white;
    }
    h2 { text-align: center; margin-bottom: 24px; }
    label { display: block; margin-top: 12px; }
    input, select {
      width: 100%; padding: 10px; margin-top: 4px;
      border: none; border-radius: 8px;
    }
    button {
      margin-top: 20px; width: 100%;
      padding: 12px; background-color: #ff9800;
      border: none; border-radius: 8px;
      color: white; font-size: 16px;
      cursor: pointer;
    }
    .warning {
      margin-top: 20px; font-size: 14px;
      background: rgba(255, 0, 0, 0.6);
      padding: 10px; border-radius: 8px;
    }
    .error {
      color: #ff4b4b;
      font-size: 13px;
      margin-top: 4px;
    }
    #loading {
      text-align: center;
      display: none;
      margin-top: 10px;
      font-style: italic;
    }
    /* Modal styles */
    #confirmModal {
      display: flex;
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      justify-content: center; align-items: center;
      padding: 20px;
      opacity: 0; pointer-events: none;
      transition: opacity 0.3s ease;
    }
    #confirmModal.show {
      opacity: 1; pointer-events: auto;
    }
    #confirmModal .modal-content {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      color: #222;
      padding: 20px; border-radius: 12px;
      max-width: 500px; width: 100%;
      box-shadow: 0 8px 20px rgba(0,0,0,0.6);
      max-height: 90%; overflow-y: auto;
      transform: scale(0.95);
      transition: transform 0.3s ease;
    }
    #confirmModal.show .modal-content {
      transform: scale(1);
    }
    #confirmModal h3 {
      text-align: center;
      margin-bottom: 15px;
      color: #ff9800;
    }
    #confirmModal ol {
      font-size: 14px; line-height: 1.6; padding-left: 18px;
    }
    #confirmModal ol li {
      margin-bottom: 8px;
    }
    #confirmModal button {
      flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer;
      font-size: 14px;
    }
    #confirmOk { background: #4CAF50; color: white; }
    #confirmCancel { background: #f44336; color: white; }
    #confirmModal .btn-group { display: flex; gap: 10px; margin-top: 15px; }
  </style>
</head>
<body>
  <div class="form-wrapper">
    <h2>Mua robux - RobuxVEX</h2>
    <button id="loginBtn">Vui lòng đăng nhập trước</button>
    <p id="userInfo"></p>

    <form id="cardForm" style="display:none">
      <label for="cardType">Loại thẻ</label>
      <select id="cardType" name="cardType">
        <option value="Viettel">Viettel</option>
        <option value="Mobifone">Mobifone</option>
        <option value="Vinaphone">Vinaphone</option>
        <option value="Vietnamobile">Vietnamobile</option>
        <option value="Zing">Zing</option>
        <option value="Vcoin">Vcoin</option>
        <option value="Garena">Garena</option>
        <option value="Gate">Gate</option>
      </select>

      <label for="amount">Mệnh giá</label>
      <select id="amount" name="amount">
        <option value="10000">10.000đ - 32 robux (120h)</option>
        <option value="20000">20.000đ - 65 robux (120h)</option>
        <option value="50000">50.000đ - 165 robux (120h)</option>
        <option value="100000">100.000đ - 335 robux (120h)</option>
        <option value="120000">120.000đ - 400 robux (1-5p)</option>
        <option value="200000">200.000đ - 680 robux (120h)</option>
        <option value="500000">500.000đ - 1710 robux (120h)</option>
      </select>

      <label for="serial">Mã serial</label>
      <input type="text" id="serial" required />
      <div id="serialError" class="error"></div>

      <label for="pin">Mã thẻ</label>
      <input type="text" id="pin" required />
      <div id="pinError" class="error"></div>

      <label for="uid">Tên Roblox</label>
      <input type="text" id="uid" required />

      <label for="contact">Thông tin liên lạc (rất quan trọng)</label>
      <input type="text" id="contact" required />
      <div id="contactError" class="error"></div>

      <div id="loading">Đang gửi...</div>
      <button type="submit">Mua robux</button>
      <div id="successMsg" style="color:limegreen; text-align:center; margin-top:15px;"></div>

      <div class="warning">
        ⚠️ Vui lòng chọn đúng mệnh giá bạn nhé!<br>
        Nếu sai mệnh giá thẻ sẽ bị trừ 50% số tiền.<br>
        Không gửi thẻ sai hoặc không tồn tại tài khoản — vi phạm sẽ bị <strong>cấm vĩnh viễn</strong>.
      </div>
    </form>
  </div>

  <!-- Modal xác nhận -->
  <div id="confirmModal">
    <div class="modal-content">
      <h3>📦 Xác nhận mua hàng</h3>
      <ol>
        <li>⏳ Robux sẽ về acc sau 2-7 ngày (thông thường là 3) - 1-5p nếu là special package.</li>
        <li>🛠 Sẽ có 4 tiến trình đơn hàng: duyệt đơn → chờ khách hàng tạo gamepass → gửi robux → hoàn thành đơn hàng.</li>
        <li>📋 Chắc chắn bạn sẽ tạo gamepass đúng giá sau khi mua hàng (khi đơn đã được duyệt, vào Lịch sử đơn hàng sẽ thấy giá robux cần cho gamepass). Liên hệ admin nếu không biết tạo: <strong>0907486634 - vochuoi86@gmail.com</strong>. Robux sẽ không được gửi nếu bạn không tạo gamepass.</li>
        <li>💰 Shop đã tính thuế Roblox 30% nên đơn sẽ tăng thêm 30% robux (VD: mua 165 robux → giá gamepass sẽ là 217 robux).</li>
        <li>📱 Để lại thông tin liên lạc thật chính xác và kiểm tra liên tục cho đến khi đơn hoàn tất. (Khuyến nghị dùng Zalo).</li>
        <li>✅ Chắc chắn rằng bạn đã đọc kỹ trước khi mua.</li>
      </ol>
      <div class="btn-group">
        <button id="confirmOk">OK, đã đọc 💸</button>
        <button id="confirmCancel">Hủy, tôi sẽ sửa lại 💔</button>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBbTe4CZM8mUqsJUyFBIjcSc3w4rvIbmzc",
      authDomain: "robuxvex.firebaseapp.com",
      projectId: "robuxvex",
      storageBucket: "robuxvex.appspot.com",
      messagingSenderId: "291500837886",
      appId: "1:291500837886:web:08ae60ca6454c209328eaf"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const loginBtn = document.getElementById("loginBtn");
    const cardForm = document.getElementById("cardForm");
    const userInfo = document.getElementById("userInfo");
    const loading = document.getElementById("loading");

    const confirmModal = document.getElementById("confirmModal");
    const confirmOk = document.getElementById("confirmOk");
    const confirmCancel = document.getElementById("confirmCancel");

    loginBtn.addEventListener("click", () => {
      auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
    });

    auth.onAuthStateChanged(user => {
      if (user) {
        cardForm.style.display = "block";
        loginBtn.style.display = "none";
        userInfo.innerText = `Đăng nhập với: ${user.email}`;
      } else {
        cardForm.style.display = "none";
        loginBtn.style.display = "block";
        userInfo.innerText = "";
      }
    });

    function clearErrors() {
      document.getElementById("serialError").innerText = "";
      document.getElementById("pinError").innerText = "";
      document.getElementById("contactError").innerText = "";
    }

    function validateFields(serial, pin, contact) {
      clearErrors();
      let isValid = true;

      if (!/^\d+$/.test(serial)) {
        document.getElementById("serialError").innerText = "Serial phải là số";
        isValid = false;
      }
      if (!/^\d+$/.test(pin)) {
        document.getElementById("pinError").innerText = "Mã thẻ phải là số";
        isValid = false;
      }
      if (contact.trim() === "") {
        document.getElementById("contactError").innerText = "Nhập liên lạc";
        isValid = false;
      }

      return isValid;
    }

    document.getElementById("cardForm").addEventListener("submit", function (e) {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) return alert("Bạn cần đăng nhập trước.");

      const serial = document.getElementById("serial").value.trim();
      const pin = document.getElementById("pin").value.trim();
      const contact = document.getElementById("contact").value.trim();
      if (!validateFields(serial, pin, contact)) return;

      // Hiện modal xác nhận
      confirmModal.classList.add("show");

      // Khi bấm OK
      confirmOk.onclick = () => {
        confirmModal.classList.remove("show");
        submitOrder();
      };

      // Khi bấm Hủy
      confirmCancel.onclick = () => {
        confirmModal.classList.remove("show");
      };
    });

    function submitOrder() {
      const user = auth.currentUser;
      const cardType = document.getElementById("cardType").value;
      const amount = document.getElementById("amount").value;
      const serial = document.getElementById("serial").value.trim();
      const pin = document.getElementById("pin").value.trim();
      const uid = document.getElementById("uid").value.trim();
      const contact = document.getElementById("contact").value.trim();

      loading.style.display = "block";

      db.collection("orders")
        .where("serial", "==", serial)
        .where("pin", "==", pin)
        .get()
        .then(snapshot => {
          if (!snapshot.empty) {
            loading.style.display = "none";
            return alert("⚠️ Thẻ này đã được gửi trước đó.");
          }

          const orderData = {
            uid: user.uid,
            robloxUid: uid,
            cardType,
            amount,
            serial,
            pin,
            contact,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          };

          const userTransactionData = {
            cardType, amount, serial, pin, robloxUid: uid, contact,
            time: new Date().toISOString()
          };

          const addOrder = db.collection("orders").add(orderData);
          const addTransaction = db.collection("users").doc(user.uid).collection("transactions").add(userTransactionData);

          return Promise.all([addOrder, addTransaction]);
        })
        .then(() => {
          document.getElementById("successMsg").innerText = "🎉 Mua hàng thành công!";
          cardForm.reset();
          setTimeout(() => {
            window.location.href = "lichsu.html";
          }, 1000);
        })
        .catch(err => {
          alert("Đã có lỗi xảy ra: " + err.message);
        })
        .finally(() => {
          loading.style.display = "none";
        });
    }
  </script>
</body>
</html>
